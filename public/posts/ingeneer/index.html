<!DOCTYPE html>
<html lang="en">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=41321&amp;path=livereload" data-no-instant defer></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Vrai Sahll - </title><meta name="description" content="Your blog description"><meta property="og:url" content="http://localhost:41321/posts/ingeneer/">
  <meta property="og:title" content="Vrai Sahll">
  <meta property="og:description" content="Breaking a hybrid RSA-ECC cryptosystem through weak prime generation.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-05-26T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-05-26T00:00:00+00:00">
    <meta property="article:tag" content="Ingeneer2025">
    <meta property="og:image" content="http://localhost:41321/posts/ingeneer/featured-image_hu_5286d650f62668b6.webp">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:41321/posts/ingeneer/featured-image_hu_5286d650f62668b6.webp">
  <meta name="twitter:title" content="Vrai Sahll">
  <meta name="twitter:description" content="Breaking a hybrid RSA-ECC cryptosystem through weak prime generation.">
<meta name="application-name" content="">
<meta name="apple-mobile-web-app-title" content=""><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:41321/posts/ingeneer/" /><link rel="prev" href="http://localhost:41321/posts/umass/" /><link rel="stylesheet" href="/css/page.min.css"><link rel="stylesheet" href="/css/home.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Vrai Sahll",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:41321\/posts\/ingeneer\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "http:\/\/localhost:41321\/posts\/ingeneer\/featured-image.webp",
                            "width":  599 ,
                            "height":  151 
                        }],"genre": "posts","keywords": "ingeneer2025","wordcount":  1519 ,
        "url": "http:\/\/localhost:41321\/posts\/ingeneer\/","datePublished": "2025-05-26T00:00:00+00:00","dateModified": "2025-05-26T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "Koyphshi"},"author": {
                "@type": "Person",
                "name": "Koyphshi"
            },"description": ""
    }
    </script></head><body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="">Koyphshi</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/">
                            Posts
                        </a><a class="menu-item" href="/categories/">
                            Categories
                        </a><a class="menu-item" href="/tags/">
                            tags
                        </a><span class="menu-item delimiter"></span><a href="#" onclick="return false;" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fa-solid fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="">Koyphshi</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/tags/" title="">tags</a><div class="menu-item"><a href="#" onclick="return false;" class="theme-switch" title="Switch Theme">
                    <i class="fa-solid fa-adjust fa-fw"></i>
                </a>
            </div></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single" data-toc="enable"><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/ingeneer/featured-image.webp"
        data-srcset="/posts/ingeneer/featured-image.webp, /posts/ingeneer/featured-image.webp 1.5x, /posts/ingeneer/featured-image.webp 2x"
        data-sizes="auto"
        alt="/posts/ingeneer/featured-image.webp"
        title="/posts/ingeneer/featured-image.webp" /></div><div class="single-card" data-image="true"><h2 class="single-title animated flipInX">Vrai Sahll</h2><div class="post-meta">
                <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><img
        class="lazyload avatar"
        src="/svg/loading.min.svg"
        data-src="/images/avatar.jpeg"
        data-srcset="/images/avatar.jpeg, /images/avatar.jpeg 1.5x, /images/avatar.jpeg 2x"
        data-sizes="auto"
        alt="/images/avatar.jpeg"
        title="/images/avatar.jpeg" /><span class="post-author-name">Koyphshi&nbsp;</span>
                            </a></span><span class="post-category">published in <a href="/categories/ctf/"><i class="fa-regular fa-folder fa-fw"></i>Ctf</a></span></div>
                <div class="post-meta-line"><span><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2025-05-26">2025-05-26</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;1519 words</span>&nbsp;
                    <span><i class="fa-regular fa-clock fa-fw"></i>&nbsp;8 minutes</span>&nbsp;</div>
            </div>
            
            <hr><div class="details toc" id="toc-static"  data-kept="">
                    <div class="details-summary toc-title">
                        <span>Contents</span>
                        <span><i class="details-icon fa-solid fa-angle-right"></i></span>
                    </div>
                    <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#tldr">TL;DR</a></li>
    <li><a href="#initial-analysis">Initial Analysis</a>
      <ul>
        <li><a href="#rsa-weakness-generate_custom_prime">RSA Weakness: <code>generate_custom_prime()</code></a></li>
        <li><a href="#elliptic-curve-encryption">Elliptic Curve Encryption</a></li>
        <li><a href="#hybrid-encryption-layer">Hybrid Encryption Layer</a></li>
      </ul>
    </li>
    <li><a href="#task-analysis">Task Analysis</a></li>
    <li><a href="#exploitation">Exploitation</a>
      <ul>
        <li><a href="#part-1-recovering-rsa-prime-lsbs">Part 1: Recovering RSA Prime LSBs</a></li>
        <li><a href="#part-2-factoring-rsa-with-coppersmiths-method">Part 2: Factoring RSA with Coppersmith&rsquo;s Method</a></li>
        <li><a href="#part-3-recovering-the-flag-via-polynomial-gcd">Part 3: Recovering the Flag via Polynomial GCD</a></li>
      </ul>
    </li>
    <li><a href="#behind-the-math">Behind the Math</a>
      <ul>
        <li><a href="#weak-prime-suffix">Weak Prime Suffix</a></li>
        <li><a href="#coppersmiths-method">Coppersmith&rsquo;s Method</a></li>
        <li><a href="#elliptic-curve-point-doubling-formula">Elliptic Curve Point Doubling Formula</a></li>
        <li><a href="#polynomial-gcd-for-common-roots">Polynomial GCD for Common Roots</a></li>
      </ul>
    </li>
    <li><a href="#conclusions">Conclusions</a></li>
  </ul>
</nav></div>
                </div><div class="content" id="content"><p>Breaking a hybrid RSA-ECC cryptosystem through weak prime generation.</p>
<div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fa-solid fa-info-circle fa-fw"></i>Challenge Info<i class="details-icon fa-solid fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><ul>
<li><strong>CTF</strong>: Ingeneer</li>
<li><strong>Challenge</strong>: Vrai Sahl</li>
<li><strong>Category</strong>: Crypto</li>
<li><strong>Points</strong>: Hard</li>
<li><strong>Description</strong>: I didn&rsquo;t have much time, so I made an easy challenge but labeled it hard—kind of like calling a first-year spell a N.E.W.T.-level exam. Sorry for the mix-up!</li>
</ul>
</div>
        </div>
    </div>
<h2 id="tldr">TL;DR</h2>
<p>This challenge presented a hybrid encryption scheme combining <strong>RSA</strong> and <strong>Elliptic Curve Cryptography (ECC)</strong>. The primary vulnerability lay in the RSA prime generation, where a significant portion of the least significant bits (LSBs) of both prime factors was generated using a predictable pattern.</p>
<p>The exploitation involved three stages:</p>
<ol>
<li><strong>Exploit weak RSA primes</strong>: Recover LSBs using the fixed 0x3 nibble vulnerability</li>
<li><strong>Factor the modulus</strong>: Apply Coppersmith&rsquo;s method to find remaining MSBs</li>
<li><strong>Extract the flag</strong>: Use polynomial GCD to find the common root of two equations</li>
</ol>
<h2 id="initial-analysis">Initial Analysis</h2>
<p>The challenge source code <code>main.py</code> reveals a multi-layered encryption process:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sage.all</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">generate_custom_prime</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">suffix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">getRandomNBitInteger</span><span class="p">(</span><span class="mi">140</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">()[</span><span class="mi">2</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">        <span class="n">prefix</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">getRandomNBitInteger</span><span class="p">(</span><span class="mi">100</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">        <span class="n">candidate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">candidate</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">candidate</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_flag_value</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;flag.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">elliptic_curve_encrypt</span><span class="p">(</span><span class="n">flag_val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">modulus</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">q</span> <span class="c1"># ecc_modulus</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">modulus</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">modulus</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">flag_val</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">flag_val</span><span class="p">))</span> <span class="o">%</span> <span class="n">modulus</span>
</span></span><span class="line"><span class="cl">    <span class="n">curve</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">modulus</span><span class="p">),</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">base</span> <span class="o">=</span> <span class="n">curve</span><span class="p">(</span><span class="n">flag_val</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">result_point</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">base</span>
</span></span><span class="line"><span class="cl">    <span class="n">encrypted</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;ANA M9WD&#39;</span><span class="p">),</span> <span class="mh">0x10001</span><span class="p">,</span> <span class="n">modulus</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;a&#34;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;b&#34;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;point&#34;</span><span class="p">:</span> <span class="n">result_point</span><span class="o">.</span><span class="n">xy</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;modulus&#34;</span><span class="p">:</span> <span class="n">modulus</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ciphertext&#34;</span><span class="p">:</span> <span class="n">encrypted</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hybrid_encrypt</span><span class="p">(</span><span class="n">flag_val</span><span class="p">,</span> <span class="n">ecc_modulus</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">P</span> <span class="o">=</span> <span class="n">generate_custom_prime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> <span class="o">=</span> <span class="n">generate_custom_prime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">rsa_modulus</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="n">Q</span>
</span></span><span class="line"><span class="cl">    <span class="n">pub</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">flag_val</span> <span class="o">+</span> <span class="n">P</span><span class="p">,</span> <span class="mh">0x10001</span><span class="p">,</span> <span class="n">ecc_modulus</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">rsa_ciphertext</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;ANA CHIKOUR&#39;</span><span class="p">),</span> <span class="mh">0x10001</span><span class="p">,</span> <span class="n">rsa_modulus</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;rsa_modulus&#34;</span><span class="p">:</span> <span class="n">rsa_modulus</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;pub&#34;</span><span class="p">:</span> <span class="n">pub</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ciphertext&#34;</span><span class="p">:</span> <span class="n">rsa_ciphertext</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag_val</span> <span class="o">=</span> <span class="n">get_flag_value</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">ecc_data</span> <span class="o">=</span> <span class="n">elliptic_curve_encrypt</span><span class="p">(</span><span class="n">flag_val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">hybrid_data</span> <span class="o">=</span> <span class="n">hybrid_encrypt</span><span class="p">(</span><span class="n">flag_val</span><span class="p">,</span> <span class="n">ecc_data</span><span class="p">[</span><span class="s2">&#34;modulus&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">save_all</span><span class="p">(</span><span class="n">ecc_data</span><span class="p">,</span> <span class="n">hybrid_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h3 id="rsa-weakness-generate_custom_prime">RSA Weakness: <code>generate_custom_prime()</code></h3>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fa-solid fa-exclamation-triangle fa-fw"></i>Critical Vulnerability<i class="details-icon fa-solid fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>The function constructs candidate primes by concatenating:</p>
<ul>
<li>A random <strong>100-bit prefix</strong></li>
<li>A random <strong>140-bit suffix</strong> (converted via <code>str → bytes → hex</code>)</li>
</ul>
<p><strong>The vulnerability</strong>: When converting a number to string, then to hex bytes, the ASCII representation of digits &lsquo;0&rsquo;-&lsquo;9&rsquo; always produces bytes starting with <code>0x3</code>:</p>
<table>
  <thead>
      <tr>
          <th>Character</th>
          <th>Hex Byte</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>&lsquo;0&rsquo;</td>
          <td>0x30</td>
      </tr>
      <tr>
          <td>&lsquo;1&rsquo;</td>
          <td>0x31</td>
      </tr>
      <tr>
          <td>&hellip;</td>
          <td>&hellip;</td>
      </tr>
      <tr>
          <td>&lsquo;9&rsquo;</td>
          <td>0x39</td>
      </tr>
  </tbody>
</table>
<p>This means <strong>the first nibble of every byte in the suffix is fixed to 0x3</strong>.</p>
</div>
        </div>
    </div>
<h3 id="elliptic-curve-encryption">Elliptic Curve Encryption</h3>
<p>An elliptic curve is defined over the ECC modulus:</p>
<p>$$E: y^2 \equiv x^3 + ax + b \pmod{n}$$</p>
<p>The flag value is used as the x-coordinate of the base point:</p>
<ul>
<li>\(\text{base} = ({\tt flag_val}, y)\)</li>
<li>\(\text{result_point} = 2 \cdot \text{base}\)</li>
</ul>
<p>The x-coordinate of <code>result_point</code> is leaked as <code>point[0]</code>.</p>
<h3 id="hybrid-encryption-layer">Hybrid Encryption Layer</h3>
<p>The crucial equation linking everything:</p>
<p>$${\tt pub} = ({\tt flag_val} + P)^{0x10001} \pmod{n}$$</p>
<p>where \(P\) is one of the weak RSA primes and \(n\) is the ECC modulus.</p>
<hr>
<h2 id="task-analysis">Task Analysis</h2>
<p>The challenge requires three sequential stages:</p>
<table>
  <thead>
      <tr>
          <th>Stage</th>
          <th>Task</th>
          <th>Method</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>1</strong></td>
          <td>Recover LSBs of \(P\) and \(Q\)</td>
          <td>Brute-force second nibble (10 candidates per byte)</td>
      </tr>
      <tr>
          <td><strong>2</strong></td>
          <td>Factor <code>rsa_modulus</code> completely</td>
          <td>Coppersmith&rsquo;s theorem on small roots</td>
      </tr>
      <tr>
          <td><strong>3</strong></td>
          <td>Extract flag value</td>
          <td>Polynomial GCD of two equations</td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="exploitation">Exploitation</h2>
<h3 id="part-1-recovering-rsa-prime-lsbs">Part 1: Recovering RSA Prime LSBs</h3>
<p>Since each byte has the first nibble fixed to 0x3, we only need to brute-force the second nibble (0-9, not 0-F). This reduces the search space from \(16 \times 16\) to \(10 \times 10\) per byte pair.</p>
<p><strong>Algorithm</strong>: Iterate from LSB upward, recovering bytes incrementally by checking if the product matches modulo powers of 16.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">bf_2nd_nibbles</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span> <span class="c1"># Possible values for the 2nd nibble of P</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span> <span class="c1"># Possible values for the 2nd nibble of Q</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Construct candidate for P&#39;s current byte: 0x3X...</span>
</span></span><span class="line"><span class="cl">            <span class="n">bfA</span> <span class="o">=</span> <span class="mh">0x3</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">A</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Construct candidate for Q&#39;s current byte: 0x3X...</span>
</span></span><span class="line"><span class="cl">            <span class="n">bfB</span> <span class="o">=</span> <span class="mh">0x3</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">B</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Check if product matches modulo 16^n</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">bfA</span> <span class="o">*</span> <span class="n">bfB</span> <span class="o">%</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span> <span class="o">%</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">bfA</span><span class="p">,</span> <span class="n">bfB</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">q</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="c1"># Recover up to 86 nibbles (43 bytes)</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">bf_2nd_nibbles</span><span class="p">(</span><span class="n">rsa_n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</span></span></code></pre></div><div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fa-solid fa-lightbulb fa-fw"></i>Why This Works<i class="details-icon fa-solid fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>If \(P \approx P_{\text{high}} \cdot 2^k + p_{\text{known}}\) and \(Q \approx Q_{\text{high}} \cdot 2^k + q_{\text{known}}\), then:</p>
<p>$$N \equiv P \cdot Q \pmod{2^{8k}}$$</p>
<p>By checking this congruence for increasing \(k\), we progressively recover more bits of both primes.</p>
</div>
        </div>
    </div>
<h3 id="part-2-factoring-rsa-with-coppersmiths-method">Part 2: Factoring RSA with Coppersmith&rsquo;s Method</h3>
<p>After recovering \(p_{\text{known}}\) and \(q_{\text{known}}\) (sufficient LSBs), we have:</p>
<p>$$P = x \cdot R + p_{\text{known}}$$
$$Q = y \cdot R + q_{\text{known}}$$</p>
<p>where \(R = 2^{\text{known_bits}}\) and \(x, y\) are the unknown high parts (small relative to \(N\)).</p>
<p>Substituting into \(N = P \cdot Q\):</p>
<p>$$N = (x \cdot R + p_{\text{known}})(y \cdot R + q_{\text{known}})$$</p>
<p>This is a bivariate polynomial with <strong>small roots</strong> \(x\) and \(y\). Coppersmith&rsquo;s theorem finds them efficiently:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">R</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">bit_length</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="s1">&#39;x y&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p_</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">R</span> <span class="o">+</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl"><span class="n">q_</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">R</span> <span class="o">+</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_</span> <span class="o">*</span> <span class="n">q_</span> <span class="o">-</span> <span class="n">rsa_n</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PR</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">rsa_n</span><span class="p">),</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="n">PR</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">gens</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Find small roots using lattice reduction</span>
</span></span><span class="line"><span class="cl"><span class="n">roots</span> <span class="o">=</span> <span class="n">small_roots</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">],</span> <span class="n">m</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">x_root</span><span class="p">,</span> <span class="n">y_root</span> <span class="o">=</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">P</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x_root</span> <span class="o">*</span> <span class="n">R</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Q</span> <span class="o">=</span> <span class="n">rsa_n</span> <span class="o">//</span> <span class="n">P</span>  <span class="c1"># Verify: rsa_n % P == 0</span>
</span></span></code></pre></div><div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fa-solid fa-pencil-alt fa-fw"></i>Coppersmith&#39;s Theorem<i class="details-icon fa-solid fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">If a polynomial \(f(x, y)\) of degree \(d\) has a root \((x_0, y_0)\) where \(|x_0| &lt; X\) and \(|y_0| &lt; Y\), and if \(XY &lt; N^{d/(d+1)}\), then the root can be found in polynomial time using lattice reduction (LLL algorithm).</div>
        </div>
    </div>
<h3 id="part-3-recovering-the-flag-via-polynomial-gcd">Part 3: Recovering the Flag via Polynomial GCD</h3>
<p>The flag is the <strong>common root</strong> of two polynomials over \(\mathbb{Z}_n\) (ECC modulus).</p>
<h4 id="polynomial-from-hybrid-encryption"><strong>Polynomial from hybrid encryption</strong></h4>
<p>From \({\tt pub} = (z + P)^{0x10001} \pmod{n}\), we get:</p>
<p>$$f(z) = (z + P)^{0x10001} - {\tt pub}$$</p>
<h4 id="polynomial-from-elliptic-curve-point-doubling"><strong>Polynomial from elliptic curve point doubling</strong></h4>
<p>For a point \((x_1, y_1)\) on \(y^2 = x^3 + ax + b\), the x-coordinate of \(2(x_1, y_1)\) is:</p>
<p>$$x_2 = \left(\frac{3x_1^2 + a}{2y_1}\right)^2 - 2x_1$$</p>
<p>With \(x_1 = z\) (the flag) and \(x_2 = {\tt point}[0]\) (known), we can eliminate \(y_1\) using \(y_1^2 = z^3 + az + b\):</p>
<p>$$4(z^3 + az + b)({\tt point}[0] + 2z) = (3z^2 + a)^2$$</p>
<p>Therefore:</p>
<p>$$g(z) = (3z^2 + a)^2 - 4(z^3 + az + b)(2z + {\tt point}[0])$$</p>
<h4 id="finding-the-common-root"><strong>Finding the common root</strong></h4>
<p>Both polynomials share \(z = {\tt flag_val}\) as a root. Computing their GCD gives \((z - m)\) where \(m = {\tt flag_val}\):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">F</span> <span class="o">=</span> <span class="n">Zmod</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">PR</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,))</span>
</span></span><span class="line"><span class="cl"><span class="n">z</span> <span class="o">=</span> <span class="n">PR</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">+</span> <span class="n">Q</span><span class="p">)</span> <span class="o">**</span> <span class="mh">0x10001</span> <span class="o">-</span> <span class="n">pub</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">z</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">z</span> <span class="o">+</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Compute polynomial GCD using Euclidean algorithm</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">pgcd</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">g1</span><span class="o">.</span><span class="n">monic</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">g2</span> <span class="k">else</span> <span class="n">pgcd</span><span class="p">(</span><span class="n">g2</span><span class="p">,</span> <span class="n">g1</span> <span class="o">%</span> <span class="n">g2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">pgcd</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>  <span class="c1"># Result is of form (z - m)</span>
</span></span><span class="line"><span class="cl"><span class="n">m</span> <span class="o">=</span> <span class="o">-</span><span class="n">result</span><span class="o">.</span><span class="n">coefficients</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Extract the root</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)))</span>  <span class="c1"># Reveal the flag!</span>
</span></span></code></pre></div><div class="details admonition success open">
        <div class="details-summary admonition-title">
            <i class="icon fa-solid fa-check-circle fa-fw"></i>Why GCD Works<i class="details-icon fa-solid fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">If \(\alpha\) is a root of both \(f(z)\) and \(g(z)\), then \((z - \alpha)\) divides \(\gcd(f(z), g(z))\). If there&rsquo;s exactly one common root, the GCD is linear: \(c(z - \alpha)\) for some constant \(c\). Normalizing to monic form gives \((z - \alpha)\) directly.</div>
        </div>
    </div>
<hr>
<h2 id="behind-the-math">Behind the Math</h2>
<h3 id="weak-prime-suffix">Weak Prime Suffix</h3>
<p>The ASCII hex encoding of digits constrains the LSBs of primes to a highly predictable pattern. This reduces brute-force complexity from exponential to tractable.</p>
<h3 id="coppersmiths-method">Coppersmith&rsquo;s Method</h3>
<p>A cornerstone of RSA cryptanalysis:</p>
<blockquote>
<p><strong>Coppersmith&rsquo;s Theorem</strong> (1997): If you know a significant portion (MSBs or LSBs) of a prime factor of \(N\), you can recover the remaining bits in polynomial time.</p>
</blockquote>
<p>This applies to our scenario where we&rsquo;ve recovered \(\approx 140\) bits of \(P\) (the suffix) out of \(\approx 240\) bits total.</p>
<h3 id="elliptic-curve-point-doubling-formula">Elliptic Curve Point Doubling Formula</h3>
<p>On the curve \(y^2 = x^3 + ax + b\), point doubling uses the tangent line&rsquo;s slope:</p>
<p>$$\lambda = \frac{3x^2 + a}{2y}$$</p>
<p>The resulting x-coordinate is:</p>
<p>$$x(2P) = \lambda^2 - 2x(P)$$</p>
<p>By substituting known values and using the curve equation, we derive a polynomial constraint on \(x(P)\).</p>
<h3 id="polynomial-gcd-for-common-roots">Polynomial GCD for Common Roots</h3>
<p>The Euclidean algorithm for polynomials finds \(\gcd(f, g)\) by successive remainder operations. If both polynomials share a root, that root appears in the GCD. For a linear GCD \((z - m)\), the constant term is \(-m\).</p>
<hr>
<h2 id="conclusions">Conclusions</h2>
<p><strong>&ldquo;Vrai Sahl&rdquo;</strong> exemplified sophisticated cryptographic vulnerabilities:</p>
<div class="details admonition success open">
        <div class="details-summary admonition-title">
            <i class="icon fa-solid fa-check-circle fa-fw"></i>Key Lessons<i class="details-icon fa-solid fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><ol>
<li>
<p><strong>Random number generation is critical</strong>: Even subtle patterns in prime construction (like ASCII hex encoding) can be exploited for complete factorization.</p>
</li>
<li>
<p><strong>Coppersmith&rsquo;s method is powerful</strong>: It transforms partial knowledge into complete recovery of cryptographic secrets.</p>
</li>
<li>
<p><strong>Hybrid systems require careful integration</strong>: Vulnerabilities in one component (RSA primes) can compromise the entire system (ECC + RSA).</p>
</li>
<li>
<p><strong>Polynomial algebra is a cryptanalytic tool</strong>: GCD computation over finite fields reveals hidden relationships between encrypted values.</p>
</li>
<li>
<p><strong>Defense requires rigor</strong>: Use cryptographic libraries&rsquo; standard random prime generators, never implement your own.</p>
</li>
</ol>
</div>
        </div>
    </div>
<p>This challenge demonstrates how cryptographic implementations with subtle flaws can be completely compromised through sophisticated mathematical attacks.</p></div><div class="post-footer" id="post-footer">
    <div class="post-info"><div class="post-info-tag"><span><a href="/tags/ingeneer2025/">Ingeneer2025</a>
                </span></div><div class="post-info-line"><div class="post-info-mod">
                <span>Updated on 2025-05-26</span>
            </div><div class="post-info-mod"></div>
        </div></div><div class="post-nav"><a href="/posts/umass/" class="prev" rel="prev" title="XORSA"><i class="fa-solid fa-angle-left fa-fw"></i>Previous Post</a></div></div>
</div></article></div>
            </main>
            <footer class="footer"><div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.152.2 (6abdacad3f3fe944ea42177844469139e81feda6)">Hugo</a> | Theme - <a href="https://github.com/khusika/FeelIt" target="_blank" rel="noopener noreffer" title="FeelIt 1.0.3"><i class="fa-solid fa-hand-holding-heart fa-fw"></i> FeelIt</a>
        </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw"></i><span itemprop="copyrightYear">2024 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/"></a></span></div>
</div>
</footer>
        </div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fa-solid fa-chevron-up fa-fw"></i>
            </a></div><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><script src="/lib/lazysizes/lazysizes.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script src="/lib/katex/katex.min.js"></script><script src="/lib/katex/auto-render.min.js"></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script src="/js/theme.min.js"></script></body></html>
